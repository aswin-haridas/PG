<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <style>
      body {
        background-color: #000000;
        font-family: "JetBrains Mono", Arial, sans-serif;
        margin: 0;
        padding: 0;
        color: #ffffff;
        overflow-x: hidden; /* Hide horizontal scrollbar */
      }

      a {
        text-decoration: none;
        color: #ffffff;
        margin: 5px 0;
      }

      a:hover {
        text-decoration: underline;
      }

      .add-btn {
        color: #9370db; /* Purple color */
        cursor: pointer;
        padding: 10px;
        text-align: center;
        background-color: #000000;
        z-index: 100;
      }

      .add-btn:hover {
        text-decoration: underline;
      }

      .snippets-btn {
        color: #9370db; /* Purple color */
        cursor: pointer;
        padding: 10px;
        text-align: center;
        background-color: #000000;
        z-index: 100;
        margin-left: 10px; /* Add some spacing between buttons */
      }

      .snippets-btn:hover {
        text-decoration: underline;
      }

      .home-btn {
        color: #ff6200;
        cursor: pointer;
        padding: 10px;
        text-align: center;
        background-color: #000000;
        z-index: 100;
        margin-left: 10px;
      }

      .home-btn:hover {
        text-decoration: underline;
      }

      .container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        align-items: center;
        padding: 0;
      }

      /* Navigation bar container */
      .nav-container {
        display: flex;
        flex-direction: row;
        width: 100%;
        background-color: #000000;
        position: sticky;
        top: 0;
        z-index: 100;
        justify-content: center;
      }

      .content-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 20px;
        overflow-y: auto;
        flex-grow: 1;
        width: 100%;
        box-sizing: border-box;
        max-width: 900px;
      }

      .snippet-form {
        display: none;
        background-color: #1e1e1e;
        padding: 20px;
        border-radius: 5px;
        width: 100%;
        margin-bottom: 20px;
        box-sizing: border-box; /* Include padding in width calculation */
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 8px;
        background-color: #2d2d2d;
        border: 1px solid #444;
        color: #fff;
        font-family: "JetBrains Mono", monospace;
        border-radius: 3px;
        box-sizing: border-box; /* Include padding in width calculation */
      }

      .form-group textarea {
        min-height: 150px;
        resize: vertical; /* Only allow vertical resizing */
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-family: "JetBrains Mono", monospace;
      }

      .btn-primary {
        background-color: #9370db;
        color: white;
      }

      .btn-secondary {
        background-color: #444;
        color: white;
        margin-left: 10px;
      }

      .snippets-list {
        width: 100%;
        margin-top: 20px;
      }

      .snippet-item {
        background-color: #1e1e1e;
        margin-bottom: 20px;
        border-radius: 5px;
        overflow: hidden;
      }

      .snippet-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: #2d2d2d;
      }

      .snippet-title {
        font-weight: bold;
        flex-grow: 1;
      }

      .snippet-actions {
        display: flex;
      }

      .action-btn {
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
        margin-left: 10px;
        font-size: 0.9em;
      }

      .copy-btn {
        color: #4caf50;
      }

      .edit-btn {
        color: #2196f3;
      }

      .delete-btn {
        color: #f44336;
      }

      .snippet-content {
        padding: 15px;
      }

      .snippet-code {
        background-color: #2d2d2d;
        border-radius: 3px;
        padding: 10px;
        overflow-x: auto;
        white-space: pre;
        max-width: 100%; /* Ensure code blocks don't exceed container width */
      }

      .snippet-description {
        margin-top: 10px;
        color: #ccc;
        font-style: italic;
      }

      .language-badge {
        background-color: #444;
        border-radius: 3px;
        padding: 2px 6px;
        font-size: 0.8em;
        margin-left: 10px;
      }

      /* Toast notification */
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #333;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 1000;
        display: none;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .show-toast {
        display: block;
        animation: fadeInOut 3s forwards;
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      /* Hide scrollbar but allow scrolling */
      .content-container::-webkit-scrollbar {
        display: none; /* Safari and Chrome */
      }

      .content-container {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }

      pre {
        max-width: 100%;
        overflow-x: auto;
      }

      code {
        word-wrap: normal;
        max-width: 100%;
      }
    </style>
    <title>Code Snippets</title>
  </head>

  <body>
    <main class="container">
      <div class="nav-container">
        <nav class="home-btn" onclick="goToHome()">Bookmarks</nav>
        <nav class="add-btn" onclick="toggleAddForm()">Add</nav>
      </div>

      <div class="content-container">
        <div class="snippet-form" id="snippet-form">
          <h2 id="form-title">Add New Snippet</h2>
          <form id="add-snippet-form">
            <input type="hidden" id="snippet-id" />
            <div class="form-group">
              <label for="title">Title:</label>
              <input type="text" id="title" required />
            </div>
            <div class="form-group">
              <label for="language">Language:</label>
              <select id="language">
                <option value="javascript">JavaScript</option>
                <option value="html">HTML</option>
                <option value="css">CSS</option>
                <option value="python">Python</option>
                <option value="java">Java</option>
                <option value="csharp">C#</option>
                <option value="cpp">C++</option>
                <option value="php">PHP</option>
                <option value="ruby">Ruby</option>
                <option value="go">Go</option>
                <option value="swift">Swift</option>
                <option value="typescript">TypeScript</option>
                <option value="shell">Shell/Bash</option>
                <option value="sql">SQL</option>
                <option value="json">JSON</option>
                <option value="xml">XML</option>
              </select>
            </div>
            <div class="form-group">
              <label for="code">Code:</label>
              <textarea id="code" required></textarea>
            </div>
            <div class="form-group">
              <label for="description">Description (optional):</label>
              <textarea id="description" rows="2"></textarea>
            </div>
            <div class="form-buttons">
              <button type="submit" class="btn btn-primary" id="save-btn">
                Save Snippet
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="toggleAddForm()"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>

        <div class="snippets-list" id="snippets-list">
          <!-- Snippets will be loaded here -->
          <div id="loading">Loading snippets...</div>
        </div>
      </div>
    </main>

    <div class="toast" id="toast">Snippet copied to clipboard!</div>

    <script>
      // Initialize highlight.js
      document.addEventListener("DOMContentLoaded", (event) => {
        hljs.highlightAll();
      });

      // Navigation functions
      function goToHome() {
        window.location.href = "/";
      }

      // Toast notification
      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show-toast");

        setTimeout(() => {
          toast.classList.remove("show-toast");
        }, 3000);
      }

      // Toggle add snippet form
      function toggleAddForm(isEdit = false) {
        const form = document.getElementById("snippet-form");
        const formTitle = document.getElementById("form-title");
        const saveBtn = document.getElementById("save-btn");

        if (form.style.display === "block" && !isEdit) {
          form.style.display = "none";
          resetForm();
        } else {
          form.style.display = "block";
          if (isEdit) {
            formTitle.textContent = "Edit Snippet";
            saveBtn.textContent = "Update Snippet";
          } else {
            formTitle.textContent = "Add New Snippet";
            saveBtn.textContent = "Save Snippet";
            resetForm();
          }
          document.getElementById("title").focus();
        }
      }

      // Reset the form
      function resetForm() {
        document.getElementById("snippet-id").value = "";
        document.getElementById("title").value = "";
        document.getElementById("language").value = "javascript";
        document.getElementById("code").value = "";
        document.getElementById("description").value = "";
      }

      // Fetch all snippets
      async function fetchSnippets() {
        try {
          const response = await fetch("/api/snippets");
          const snippets = await response.json();

          const snippetsList = document.getElementById("snippets-list");
          snippetsList.innerHTML = "";

          if (snippets.length === 0) {
            snippetsList.innerHTML =
              "<p>No snippets found. Add your first snippet!</p>";
            return;
          }

          snippets.forEach((snippet) => {
            const snippetItem = createSnippetElement(snippet);
            snippetsList.appendChild(snippetItem);
          });

          // Re-highlight code
          hljs.highlightAll();
        } catch (error) {
          console.error("Error fetching snippets:", error);
          document.getElementById("snippets-list").innerHTML =
            "<p>Failed to load snippets. Please try again later.</p>";
        }
      }

      // Create snippet DOM element
      function createSnippetElement(snippet) {
        const item = document.createElement("div");
        item.className = "snippet-item";
        item.dataset.id = snippet._id;

        item.innerHTML = `
          <div class="snippet-header">
            <div class="snippet-title">${snippet.title}
              <span class="language-badge">${snippet.language}</span>
            </div>
            <div class="snippet-actions">
              <button class="action-btn copy-btn" onclick="copySnippet('${
                snippet._id
              }')">Copy</button>
              <button class="action-btn edit-btn" onclick="editSnippet('${
                snippet._id
              }')">Edit</button>
              <button class="action-btn delete-btn" onclick="deleteSnippet('${
                snippet._id
              }')">Delete</button>
            </div>
          </div>
          <div class="snippet-content">
            <pre><code class="language-${snippet.language}">${escapeHtml(
          snippet.code
        )}</code></pre>
            ${
              snippet.description
                ? `<div class="snippet-description">${snippet.description}</div>`
                : ""
            }
          </div>
        `;

        return item;
      }

      // Escape HTML to prevent XSS
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Copy snippet to clipboard
      async function copySnippet(id) {
        try {
          const response = await fetch(`/api/snippets/${id}`);
          const snippet = await response.json();

          await navigator.clipboard.writeText(snippet.code);
          showToast("Snippet copied to clipboard!");
        } catch (error) {
          console.error("Failed to copy snippet:", error);
          showToast("Failed to copy snippet");
        }
      }

      // Edit snippet
      async function editSnippet(id) {
        try {
          const response = await fetch(`/api/snippets/${id}`);
          const snippet = await response.json();

          document.getElementById("snippet-id").value = snippet._id;
          document.getElementById("title").value = snippet.title;
          document.getElementById("language").value = snippet.language;
          document.getElementById("code").value = snippet.code;
          document.getElementById("description").value =
            snippet.description || "";

          toggleAddForm(true);
        } catch (error) {
          console.error("Failed to load snippet for editing:", error);
          showToast("Failed to load snippet for editing");
        }
      }

      // Delete snippet
      async function deleteSnippet(id) {
        if (!confirm("Are you sure you want to delete this snippet?")) {
          return;
        }

        try {
          const response = await fetch(`/api/snippets/${id}`, {
            method: "DELETE",
          });

          if (response.ok) {
            const snippetElement = document.querySelector(
              `.snippet-item[data-id="${id}"]`
            );
            if (snippetElement) {
              snippetElement.remove();
            }
            showToast("Snippet deleted successfully");

            // Check if no snippets remain
            const snippetsList = document.getElementById("snippets-list");
            if (snippetsList.children.length === 0) {
              snippetsList.innerHTML =
                "<p>No snippets found. Add your first snippet!</p>";
            }
          } else {
            throw new Error("Failed to delete snippet");
          }
        } catch (error) {
          console.error("Failed to delete snippet:", error);
          showToast("Failed to delete snippet");
        }
      }

      // Handle form submission
      document
        .getElementById("add-snippet-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const snippetId = document.getElementById("snippet-id").value;
          const title = document.getElementById("title").value.trim();
          const language = document.getElementById("language").value;
          const code = document.getElementById("code").value;
          const description = document
            .getElementById("description")
            .value.trim();

          if (!title || !code) {
            showToast("Title and Code are required");
            return;
          }

          const snippetData = {
            title,
            language,
            code,
            description,
          };

          try {
            let response;
            let method;
            let endpoint;

            if (snippetId) {
              // Update existing snippet
              method = "PUT";
              endpoint = `/api/snippets/${snippetId}`;
            } else {
              // Create new snippet
              method = "POST";
              endpoint = "/api/snippets";
            }

            response = await fetch(endpoint, {
              method,
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(snippetData),
            });

            if (response.ok) {
              showToast(
                snippetId
                  ? "Snippet updated successfully"
                  : "Snippet added successfully"
              );
              toggleAddForm(false);
              fetchSnippets();
            } else {
              throw new Error("Failed to save snippet");
            }
          } catch (error) {
            console.error("Error saving snippet:", error);
            showToast("Failed to save snippet");
          }
        });

      // Load snippets when page loads
      window.onload = fetchSnippets;
    </script>
  </body>
</html>
